# ==================== OxiProxy Docker Compose 配置 ====================
#
# 本文件提供完整的 OxiProxy 部署示例（Controller + Node）
#
# 如需单独部署，请使用以下文件：
# - docker-compose.controller.yml  # 仅部署 Controller
# - docker-compose.node.yml        # 仅部署 Node (Agent Server)
# - docker-compose.client.yml      # 仅部署 Client (Agent Client)
#
# 使用方法：
# 1. 完整部署: docker-compose up -d
# 2. 仅 Controller: docker-compose -f docker-compose.controller.yml up -d
# 3. 仅 Node: docker-compose -f docker-compose.node.yml up -d
# 4. 仅 Client: docker-compose -f docker-compose.client.yml up -d
#
# ================================================================

services:
  # ==================== OxiProxy Controller ====================
  # 中央控制器，提供 Web 管理界面和 gRPC 服务
  controller:
    image: ghcr.io/oxiproxy/oxiproxy:latest
    container_name: oxiproxy-controller
    restart: unless-stopped

    # 端口映射
    ports:
      # Web 管理界面端口 (HTTP)
      # 访问: http://your-server-ip:3000
      # 默认账号: admin (密码见首次启动日志)
      - "3000:3000"
      # gRPC 服务端口 (Agent 连接使用)
      - "3100:3100"

    # 卷挂载
    volumes:
      # 数据持久化目录 (SQLite 数据库、日志等)
      - ./data:/app/data

    # 环境变量
    environment:
      # JWT 密钥（可选，不设置则系统自动生成）
      # - JWT_SECRET=your-secret-key-here
      # 时区设置
      - TZ=Asia/Shanghai
      # 日志级别
      - RUST_LOG=info,tokio_kcp=off

    # 启动命令
    command: ["/app/controller"]

    # 健康检查
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    networks:
      - oxiproxy-network

  # ==================== OxiProxy Node (可选) ====================
  # 节点服务，提供隧道服务
  # 如果 Node 部署在其他服务器上，可以注释掉此服务
  node:
    image: ghcr.io/oxiproxy/oxiproxy:latest
    container_name: oxiproxy-node
    restart: unless-stopped

    # 端口映射
    ports:
      # 隧道服务端口 (QUIC/KCP 协议, UDP)
      - "7000:7000/udp"
      # 代理端口范围（根据实际配置的代理端口调整）
      # - "10000-10100:10000-10100/tcp"
      # - "10000-10100:10000-10100/udp"

    # 环境变量
    environment:
      # 时区设置
      - TZ=Asia/Shanghai
      # 日志级别
      - RUST_LOG=info,tokio_kcp=off

    # 启动命令
    command:
      - /app/node
      - --controller-url
      - http://controller:3100
      - --token
      - ${NODE_TOKEN:-your-node-token-here}
      - --bind-port
      - "7000"

    # 依赖关系
    depends_on:
      controller:
        condition: service_healthy

    networks:
      - oxiproxy-network

  # ==================== OxiProxy Client (可选) ====================
  # 客户端服务，通常部署在内网机器上
  # 如果 Client 部署在其他服务器上，可以注释掉此服务
  # client:
  #   image: ghcr.io/oxiproxy/oxiproxy:latest
  #   container_name: oxiproxy-client
  #   restart: unless-stopped
  #   network_mode: host
  #
  #   environment:
  #     # Controller 地址（需要改为实际的 Controller IP）
  #     - CONTROLLER_URL=http://your-controller-ip:3100
  #     # 客户端 Token（从 Controller Web 界面获取）
  #     - CLIENT_TOKEN=${CLIENT_TOKEN:-your-client-token-here}
  #     - TZ=Asia/Shanghai
  #     - RUST_LOG=info,tokio_kcp=off
  #
  #   command:
  #     - /app/client
  #     - --controller-url
  #     - ${CONTROLLER_URL:-http://your-controller-ip:3100}
  #     - --token
  #     - ${CLIENT_TOKEN:-your-client-token-here}

# 网络配置
networks:
  oxiproxy-network:
    driver: bridge
